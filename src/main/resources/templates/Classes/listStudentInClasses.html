<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Danh sách sinh viên</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>

    <!--css-->
    <link th:href="@{/css/bootstrap.css}" rel="stylesheet"/>
    <link th:href="@{/css/main.css}" rel="stylesheet"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.6.0/font/bootstrap-icons.css">
    <style>
        table{
          width:100%;
          table-layout: fixed;
        }
        .tbl-header{
            margin: 0;
            padding: 0;
        }
        .tbl-content{
            height:420px;
            overflow-x:auto;
            margin-top: 0px;
            margin: 0;
            padding: 0;
        }

    </style>

    <!--js-->
    <script th:src="@{/js/bootstrap.js}"></script>
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>

    <script th:inline="javascript">
        $(document).ready(function() {
        $(window).on("load resize ", function() {
                var scrollWidth = $('.tbl-content').width() - $('.tbl-content table').width();
                $('.tbl-header').css({'padding-right':scrollWidth});
            }).resize();
    $(".header-clickable").click(function(e) {
        if(e.target.id !== "searchInput") {
            // Click was outside input, toggle visibility
            $("#searchInput").toggle();
        }
    });
    // Prevent hiding on input clicks
    $("#searchInput").click(function(e) {
        e.stopPropagation();
    });

    /*<![CDATA[*/
    var students = /*[[${studentListInClasses}]]*/;
    /*]]>*/

    $('#searchInput').on('keyup', function(){
        var value = $(this).val();
        console.log('Value = ' + value);
        var data = FilterFunction(value, students);

        rebuildTable(data)
    });

    function FilterFunction(value, data){
        var filteredData = [];
        for(var i = 0; i < data.length; i++){
            value = value.toLowerCase();
            var fName = data[i].first_name.toLowerCase();
            var mName = data[i].middle_name.toLowerCase();
            var lName = data[i].last_name.toLowerCase();
            if(fName.includes(value) || mName.includes(value) || lName.includes(value)){
                filteredData.push(data[i]);
            }
        }
        return filteredData;
    }

    function rebuildTable(data){
        var table = document.getElementById('studentTableBody');
        if (table) { // Check if the table exists
            table.innerHTML = '';
            for(var i = 0; i < data.length; i++){
                var student = data[i];
                var row = `<tr>
                                <td><a class="link-offset-2 link-underline link-underline-opacity-0"
                   href="/v1/student/studentInfo?ID=${student.id}">${student.id}</a></td>
                    <td><span>${student.last_name} ${student.middle_name} ${student.first_name}</span></td>
                    <td>${student.gpa.toFixed(2)}</td>
                    <td><span>${student.total_credit}</span></td>
                    <td>${student.total_cumulative_credits}</td>
                    </tr>`;
                table.innerHTML += row;
            }
        } else {
            console.log("Table with id 'studentTable' does not exist.");
        }
    }
});

    </script>
</head>
<body>
<h1>Danh sách sinh viên lớp <span th:text="${className}"></span></h1>
<div class="container">
    <form th:action="@{/v1/class/listStudentInClasses}" method="get">
        <input type="hidden" name="className" th:value="${className}">
        <div class="form-group  mb-3 row">
            <label for="studentType" class="col-md-2 col-form-label">Chọn sinh viên</label>
            <select class="form-control col-md-4" id="studentType" name="studentType">
                <option value="all">Tất cả</option>
                <option value="excellent">Sinh viên xuất sắc</option>
                <option value="good">Sinh viên giỏi</option>
                <option value="poor">Sinh viên kém</option>
            </select>
        </div>
        <div class="col-md-2">
            <button type="submit" class="btn btn-primary">Chọn</button>
        </div>
    </form>
</div>
<br>
<p><i>Danh sách có <span th:text="${size}"></span> sinh viên.</i></p>

<div class="tbl-header">
    <table class="table table-bordered table-hover">
        <thead class="table-primary">
        <th>Mã sinh viên</th>
        <th id="name-header" class="header-clickable">
            Họ tên
            <input type="text" id="searchInput" class="form-control" style="display: none; margin-top: 5px;">
        </th>
        <th th:replace="~{Classes/sorting :: sorting('GPA', 'GPA')}">GPA</th>
        <th th:replace="~{Classes/sorting :: sorting('total_credit', 'Tổng tín chỉ')}">Tổng tín chỉ</th>
        <th th:replace="~{Classes/sorting :: sorting('total_cumulative_credits', 'Tổng tín chỉ tích lũy')}">Tổng tín chỉ
            tích lũy
        </th>
        </thead>
    </table>
</div>
<div class="tbl-content">
    <table class="table table-bordered table-hover">
        <tbody id="studentTableBody">
        <tr th:each="student : ${studentListInClasses}">
            <td><a class="link-offset-2 link-underline link-underline-opacity-0"
                   th:href="@{/v1/student/studentInfo(ID = ${student.getID()})}"
                   th:text="*{student.getID()}">Mã sinh viên</a></td>
            <td><span
                    th:text="*{student.getLast_name + ' ' + student.getMiddle_name + ' ' + student.getFirst_name}"> Họ tên</span>
            </td>
            <td th:text="${#numbers.formatDecimal(student.getGPA(), 1, 'COMMA', 2, 'POINT')}">GPA</td>

            <td><span th:text="*{student.getTotal_credit()}"> Tổng tín chỉ tích lũy </span></td>
            <td th:text="${student.total_cumulative_credits}"></td>
        </tr>
        </tbody>
    </table>
</div>

<a href="/" class="btn btn-success"><i class="bi bi-house"></i></a>
</body>
</html>